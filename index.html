<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLESS é…ç½®æ‰¹é‡è½¬æ¢å·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .textarea {
            width: 100%;
            height: 300px;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-family: monospace;
            font-size: 0.875rem;
            resize: vertical;
        }

        .textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: transparent;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #f9fafb;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .button-group .btn {
            flex: 1;
        }

        .result-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            margin-bottom: 0.75rem;
        }

        .result-index {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .result-link {
            font-family: monospace;
            font-size: 0.75rem;
            word-break: break-all;
            margin-bottom: 0.5rem;
        }

        .result-actions {
            display: flex;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
        }

        .instructions {
            margin-top: 2rem;
        }

        .instructions ul {
            list-style: none;
            padding: 0;
        }

        .instructions li {
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .instructions li:before {
            content: "â€¢";
            color: #3b82f6;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        .status {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VLESS é…ç½®æ‰¹é‡è½¬æ¢å·¥å…·</h1>
        </div>

        <div class="grid">
            <!-- å·¦ä¾§è¾“å…¥åŒºåŸŸ -->
            <div class="card">
                <h2>é…ç½®è¾“å…¥</h2>
                <textarea 
                    id="configInput" 
                    class="textarea" 
                    placeholder="ç²˜è´´ JSON é…ç½®åˆ°è¿™é‡Œ..."
                ></textarea>
                
                <div class="button-group">
                    <button id="convertBtn" class="btn btn-primary">å¼€å§‹è½¬æ¢</button>
                    <button id="exampleBtn" class="btn btn-secondary">åŠ è½½ç¤ºä¾‹</button>
                    <button id="clearBtn" class="btn btn-secondary">æ¸…ç©º</button>
                </div>
            </div>

            <!-- å³ä¾§ç»“æœåŒºåŸŸ -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>è½¬æ¢ç»“æœ</h2>
                    <button id="copyAllBtn" class="btn btn-success" style="display: none;">å¤åˆ¶å…¨éƒ¨</button>
                </div>
                
                <div id="resultList" class="result-list">
                    <div class="empty-state">è½¬æ¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
                
                <div id="status" class="status"></div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="card instructions">
            <h2>ä½¿ç”¨è¯´æ˜</h2>
            <ul>
                <li>æ”¯æŒå•ä¸ª JSON é…ç½®æˆ–å¤šä¸ªé…ç½®çš„æ•°ç»„</li>
                <li>æ”¯æŒ VLESS over WS/TLS ç­‰å¸¸è§é…ç½®</li>
                <li>è‡ªåŠ¨æå–æœåŠ¡å™¨åœ°å€ã€ç«¯å£ã€UUIDã€è·¯å¾„ç­‰ä¿¡æ¯</li>
                <li>æ‰¹é‡å¤åˆ¶æ‰€æœ‰ç”Ÿæˆçš„ VLESS é“¾æ¥</li>
                <li>çº¯å‰ç«¯è½¬æ¢ï¼Œæ•°æ®ä¸ä¼šå‘é€åˆ°æœåŠ¡å™¨</li>
            </ul>
        </div>
    </div>

    <script>
        // ç¤ºä¾‹é…ç½®
        const exampleConfig = `{
  "remarks": "ğŸ’¦ Example - VLESS",
  "outbounds": [
    {
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "example.com",
            "port": 443,
            "users": [
              {
                "id": "1498fce7-feb0-4e44-9236-f957a3495ea0",
                "encryption": "none"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "ws",
        "security": "tls",
        "wsSettings": {
          "host": "example.com",
          "path": "/path"
        }
      }
    }
  ]
}`;

        // DOM å…ƒç´ 
        const configInput = document.getElementById('configInput');
        const convertBtn = document.getElementById('convertBtn');
        const exampleBtn = document.getElementById('exampleBtn');
        const clearBtn = document.getElementById('clearBtn');
        const copyAllBtn = document.getElementById('copyAllBtn');
        const resultList = document.getElementById('resultList');
        const status = document.getElementById('status');

        // è½¬æ¢å‡½æ•°
        function convertToVless(config) {
            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°ç»„æ ¼å¼
                const outbound = Array.isArray(config.outbounds) ? config.outbounds[0] : config.outbounds;
                
                if (!outbound || outbound.protocol !== 'vless') {
                    throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„ VLESS é…ç½®');
                }

                const vnext = outbound.settings?.vnext?.[0];
                if (!vnext) {
                    throw new Error('ç¼ºå°‘ vnext é…ç½®');
                }

                const user = vnext.users?.[0];
                if (!user) {
                    throw new Error('ç¼ºå°‘ç”¨æˆ·é…ç½®');
                }

                const address = vnext.address;
                const port = vnext.port;
                const uuid = user.id;
                const encryption = user.encryption || 'none';

                // æå–æµè®¾ç½®
                const streamSettings = outbound.streamSettings || {};
                const security = streamSettings.security || 'none';
                const network = streamSettings.network || 'tcp';

                // æ„å»ºåŸºç¡€é“¾æ¥
                let vlessLink = `vless://${uuid}@${address}:${port}?encryption=${encryption}&security=${security}&type=${network}`;

                // æ·»åŠ ä¼ è¾“åè®®ç‰¹å®šå‚æ•°
                if (network === 'ws') {
                    const wsSettings = streamSettings.wsSettings || {};
                    const host = wsSettings.host || '';
                    const path = wsSettings.path || '';
                    
                    if (host) {
                        vlessLink += `&host=${encodeURIComponent(host)}`;
                    }
                    if (path) {
                        vlessLink += `&path=${encodeURIComponent(path)}`;
                    }
                } else if (network === 'grpc') {
                    const grpcSettings = streamSettings.grpcSettings || {};
                    const serviceName = grpcSettings.serviceName || '';
                    if (serviceName) {
                        vlessLink += `&serviceName=${encodeURIComponent(serviceName)}`;
                    }
                }

                // æ·»åŠ  SNI (å¦‚æœæœ‰)
                if (streamSettings.tlsSettings && streamSettings.tlsSettings.serverName) {
                    vlessLink += `&sni=${encodeURIComponent(streamSettings.tlsSettings.serverName)}`;
                }

                // æ·»åŠ å¤‡æ³¨
                const remarks = config.remarks || config.name || 'VLESS-Server';
                vlessLink += `#${encodeURIComponent(remarks)}`;

                return vlessLink;
            } catch (error) {
                throw new Error(`é…ç½®è½¬æ¢å¤±è´¥: ${error.message}`);
            }
        }

        // æ‰¹é‡è½¬æ¢å‡½æ•°
        function batchConvert() {
            const inputText = configInput.value.trim();
            
            if (!inputText) {
                showStatus('è¯·è¾“å…¥é…ç½®å†…å®¹', 'error');
                return;
            }

            convertBtn.disabled = true;
            convertBtn.textContent = 'è½¬æ¢ä¸­...';

            try {
                let configData;
                try {
                    configData = JSON.parse(inputText);
                } catch (parseError) {
                    throw new Error('JSON æ ¼å¼é”™è¯¯: ' + parseError.message);
                }

                // å¤„ç†å•ä¸ªé…ç½®æˆ–å¤šä¸ªé…ç½®
                const configs = Array.isArray(configData) ? configData : [configData];
                const links = [];

                for (const configItem of configs) {
                    try {
                        const vlessLink = convertToVless(configItem);
                        if (vlessLink) {
                            links.push(vlessLink);
                        }
                    } catch (error) {
                        console.error('è½¬æ¢å•ä¸ªé…ç½®å¤±è´¥:', error);
                        // ç»§ç»­å¤„ç†å…¶ä»–é…ç½®
                    }
                }

                if (links.length === 0) {
                    throw new Error('æ²¡æœ‰æˆåŠŸè½¬æ¢ä»»ä½•é…ç½®');
                }

                displayResults(links);
                showStatus(`å…± ${links.length} ä¸ªé“¾æ¥è½¬æ¢æˆåŠŸ`, 'success');
                
            } catch (error) {
                showStatus('è½¬æ¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                convertBtn.disabled = false;
                convertBtn.textContent = 'å¼€å§‹è½¬æ¢';
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(links) {
            resultList.innerHTML = '';
            
            if (links.length === 0) {
                resultList.innerHTML = '<div class="empty-state">è½¬æ¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>';
                copyAllBtn.style.display = 'none';
                return;
            }

            links.forEach((link, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.innerHTML = `
                    <div class="result-index">é“¾æ¥ ${index + 1}</div>
                    <div class="result-link">${link}</div>
                    <div class="result-actions">
                        <button class="btn btn-primary" onclick="copyToClipboard('${link.replace(/'/g, "\\'")}')">å¤åˆ¶</button>
                    </div>
                `;
                resultList.appendChild(resultItem);
            });

            copyAllBtn.style.display = 'inline-flex';
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            });
        }

        // å¤åˆ¶å…¨éƒ¨
        function copyAllResults() {
            const links = Array.from(resultList.querySelectorAll('.result-link'))
                .map(el => el.textContent);
            copyToClipboard(links.join('\n'));
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            status.textContent = message;
            status.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#6b7280';
        }

        // åŠ è½½ç¤ºä¾‹
        function loadExample() {
            configInput.value = exampleConfig;
            showStatus('ç¤ºä¾‹é…ç½®å·²åŠ è½½', 'success');
        }

        // æ¸…ç©º
        function clearAll() {
            configInput.value = '';
            resultList.innerHTML = '<div class="empty-state">è½¬æ¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>';
            copyAllBtn.style.display = 'none';
            showStatus('', '');
        }

        // äº‹ä»¶ç›‘å¬
        convertBtn.addEventListener('click', batchConvert);
        exampleBtn.addEventListener('click', loadExample);
        clearBtn.addEventListener('click', clearAll);
        copyAllBtn.addEventListener('click', copyAllResults);

        // ä½¿å‡½æ•°åœ¨å…¨å±€å¯ç”¨
        window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>
